{% extends 'base.html' %}
{% block content %}
<div class="max-w-5xl mx-auto space-y-5">
  <header class="border-b border-black pb-4">
    <h1 class="text-2xl text-black">Manage Homes</h1>
    <p class="text-md text-black">Update details or add another home.</p>
  </header>
    {#    Home Section#}
  <section class="border rounded bg-[#dbf3fa] p-4 text-black space-y-4">
      {#    Display current home and switch home section#}
    <div class="grid gap-4 md:grid-cols-2">
      <div class="border  rounded p-3 ">
        <p class="text-sm text-black mb-2">Edit {{ home.name }}</p>
        <form method="post" class="space-y-2">
          {% csrf_token %}
          <input type="hidden" name="action" value="update-home">
          <input name="home_name" value="{{ home.name }}" class="w-full border px-2 py-1" required>
          <input name="home_address" value="{{ home.address }}" placeholder="Address" class="w-full border px-2 py-1" required>
          <div class="grid grid-cols-2 gap-2">
            <input name="home_city" value="{{ home.city }}" placeholder="City" class="w-full border px-2 py-1" required>
            <input name="home_state" value="{{ home.state }}" placeholder="State" class="w-full border px-2 py-1" required>
          </div>
          <input name="home_zip" value="{{ home.zip_code }}" placeholder="Zip Code" class="w-full border px-2 py-1" required>
          <button type="submit" class="border px-3 py-1 bg-green-400">Save</button>
        </form>
      </div>

      <div class="border rounded p-3 ">
        <p class="text-sm text-black mb-2">Add another home</p>
        <form method="post" class="space-y-2">
          {% csrf_token %}
          <input type="hidden" name="action" value="add-home">
          <input name="home_name" placeholder="Home name" class="w-full border px-2 py-1" required>
          <input name="home_address" placeholder="Address" class="w-full border px-2 py-1">
          <div class="grid grid-cols-2 gap-2">
            <input name="home_city" placeholder="City" class="w-full border px-2 py-1">
            <input name="home_state" placeholder="State" class="w-full border px-2 py-1">
          </div>
          <input name="home_zip" placeholder="Zip Code" class="w-full border px-2 py-1">
          <button type="submit" class="border px-3 py-1 bg-green-400">Add home</button>
        </form>
      </div>
    </div>
  </section>

  {#Add room  & asset section#}
  <section class="text-black grid gap-4 md:grid-cols-2">
    <form method="post" class="border rounded bg-[#dbf3fa] p-4 space-y-2">
      {% csrf_token %}
        {#These inputs tell our backend what actions to perform and which room view to return after submission#}
      <input type="hidden" name="action" value="add-room">
      <input type="hidden" name="return_room" value="{{ selected_room_id }}">
      <p class="text-sm ">Add room to {{ home.name }}</p>
      <input name="room_name" placeholder="Room name" class="w-full border px-2 py-1" required>
      <textarea name="room_description" placeholder="Description" class="w-full border px-2 py-1" rows="2"></textarea>
      <button type="submit" class="border px-3 py-1 bg-green-400">Save</button>
    </form>
    <form method="post" class="border rounded bg-[#dbf3fa] p-4 space-y-2">
{#        Adjust flow entirely. See script below. Conditionally prompt for appliance/consumable fields.#}
      {% csrf_token %}
      <input type="hidden" name="action" value="add-asset">
      <input type="hidden" name="return_room" value="{{ selected_room_id }}">
      <p class="text-sm ">Add asset</p>
      <input name="asset_name" placeholder="Asset name" class="w-full border px-2 py-1" required>
        <select name="asset_room" class="w-full border px-2 py-1" required>
            <option value="" class="">Select Room</option>
            {% for room in rooms %}
                <option value="{{ room.room_id }}">{{ room.name }}</option>
            {% endfor %}
        </select>
      <select name="asset_category" id="categorySelect" class="w-full border px-2 py-1">
          {% for value, label in category_choices %}
              <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
      </select>
      <div id="applianceFields" style="display: none;" class="space-y-2">
        <select name="asset_brand" id="brandSelect" class="w-full border px-2 py-1">
          <option value="">Select Brand</option>
          {% for value, label in brand_choices %}
            <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
        <input name="asset_model_number" placeholder="Model Number" class="w-full border px-2 py-1">
        <div class="space-y-2">
{#        Conditional check to show fields if consumable value is yes#}
          <p class="text-xs text-black font-medium">Does this appliance use a consumable?</p>
          <div class="flex items-center gap-4 text-xs">
            <label class="flex items-center gap-1">
              <input type="radio" name="asset_has_consumable" value="yes"> Yes
            </label>
            <label class="flex items-center gap-1">
              <input type="radio" name="asset_has_consumable" value="no" checked> No
            </label>
          </div>
          <div id="consumableFields" style="display: none;" class="space-y-2">
            <input name="consumable_name" placeholder="Consumable name" class="w-full border px-2 py-1" data-consumable-field>
            <input name="consumable_part_number" placeholder="Part number" class="w-full border px-2 py-1" data-consumable-field>
            <input name="consumable_cost" placeholder="Estimated cost (TODO!!!)" class="w-full border px-2 py-1" data-consumable-field>
            <select name="consumable_interval" class="w-full border px-2 py-1" data-consumable-field>
              <option value="">Replace interval</option>
              {% for value, label in interval_choices %}
                <option value="{{ value }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
      </div>
      <button type="submit" class="border px-3 py-1 bg-green-400">Save</button>
    </form>
  </section>

    {#Add task & log section. It is basically just a copy paste of the asset but for logs and tasks#}
  <section class="text-black grid gap-4 md:grid-cols-2">
    <form method="post" class="border rounded bg-[#dbf3fa] p-4 space-y-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="add-task">
      <input type="hidden" name="return_room" value="{{ selected_room_id }}">
      <p class="text-sm ">Add task</p>
    <div class="border-b space-y-2 pb-2">
        <input name="task_name" placeholder="Task name (e.g., change air filter)" class="w-full border px-2 py-1" required>
        <select name="task_interval" class="w-full border px-2 py-1" title="Select how often this task recurs (optional)">
            <option value="">One-time</option>
            {% for value, label in interval_choices %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
        <input type="date" name="task_start_date" placeholder="First due date" class="w-full border px-2 py-1" required>
        <p class="text-xs text-black">Select the first due date</p>
    </div>

      <select name="task_room" class="w-full border px-2 py-1">
        <option value="">Room (optional)</option>
        {% for room in rooms %}
          <option value="{{ room.room_id }}">{{ room.name }}</option>
        {% endfor %}
      </select>
      <select name="task_asset" class="w-full border px-2 py-1">
        <option value="">Asset (optional)</option>
        {% for asset in asset_choices %}
          <option value="{{ asset.asset_id }}">{{ asset.name }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="border px-3 py-1 bg-green-400">Save</button>
    </form>
    <form method="post" class="border rounded bg-[#dbf3fa] p-4 space-y-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="add-log">
      <input type="hidden" name="return_room" value="{{ selected_room_id }}">
      <p class="text-sm ">Add log</p>
    <div class="border-b space-y-2 pb-2">
        <select name="log_task" class="w-full border px-2 py-1" required>
            <option value="">Choose task</option>
            {% for task in task_choices %}
                <option value="{{ task.task_id }}">{{ task.name }}</option>
            {% endfor %}
        </select>
        <input type="date" name="log_completion_date" class="w-full border px-2 py-1">
        <p class="text-xs text-black">Completion date (optional)</p>
    </div>

      <input name="log_cost" placeholder="Cost" class="w-full border px-2 py-1">
      <textarea name="log_notes" placeholder="Notes" class="w-full border px-2 py-1" rows="2"></textarea>
      <button type="submit" class="border px-3 py-1 bg-green-400">Save</button>
    </form>
  </section>
  <script>
      //{#Show particular fields based on category selection. (change display to block#}
    const categorySelect = document.getElementById('categorySelect');
    const applianceFields = document.getElementById('applianceFields');
    const consumableFields = document.getElementById('consumableFields');
    const consumableRadios = document.querySelectorAll('input[name="asset_has_consumable"]');
    const brandSelect = document.getElementById('brandSelect');
    const consumableInputs = document.querySelectorAll('[data-consumable-field]');

    function updateApplianceFields() {
      const isAppliance = categorySelect.value === 'Appliance';
      applianceFields.style.display = isAppliance ? 'block' : 'none';
      brandSelect.required = isAppliance;
      //{#Makes consumable fields optional if appliance has no consumable || is not an appliance#}
      if (!isAppliance) {
        consumableFields.style.display = 'none';
        consumableInputs.forEach((input) => {
          input.required = false;
        });
      }
    }

    function updateConsumableFields() {
      const selected = document.querySelector('input[name="asset_has_consumable"]:checked');
      const show = selected && selected.value === 'yes';
      consumableFields.style.display = show ? 'block' : 'none';
      consumableInputs.forEach((input) => {
        input.required = show;
      });
    }

    //{#When appliance is selected, show appliance fields and brand select#}
    categorySelect.addEventListener('change', updateApplianceFields);
    //{#When consumable is selected, show consumable fields and consumable inputs#}
    consumableRadios.forEach((radio) => radio.addEventListener('change', updateConsumableFields));
    updateApplianceFields();
    updateConsumableFields();
  </script>
</div>
{% endblock %}
