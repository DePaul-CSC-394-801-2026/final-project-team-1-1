{% extends 'base.html' %}

{% for task in tasks %}
  {% if task.days_until_due != None and task.days_until_due <= 4 %}
    <div class = "bg-red-500 text-white p-4 rounded-lg flex"> 
      <div>
        <span class = "font-bold uppercase tracking-wider">Urgent</span>
        {{ task.name }} is due in {{task.days_until_due}} days!
      </div>
      <a href = "" class = "">

    </div>
  {% endif%}
{% endfor %}



{% block content %}
<div class="max-w-5xl mx-auto space-y-5">
  <header class="border-b pb-4">
    <h1 class="text-2xl text-black">Dashboard</h1>
    <p class="text-md text-black">Welcome, {{ request.session.username }}.</p>
  </header>
    {#Global stats#}
  <section class="grid grid-cols-3 gap-4">
    <div class="border rounded p-3 bg-[#dbf3fa] text-black">
      <p class="text-xs uppercase text-black">Rooms</p>
      <p class="text-3xl font-bold">{{ rooms.count }}</p>
      <p class="text-sm text-black">total</p>
    </div>
    <div class="border rounded p-3 bg-[#dbf3fa]">
      <p class="text-xs uppercase text-black">Assets</p>
      <p class="text-3xl font-bold">{{ assets.count }}</p>
      <p class="text-sm text-black">in view</p>
    </div>
    <div class="border rounded p-3 bg-[#dbf3fa]">
      <p class="text-xs uppercase text-black">Tasks</p>
      <p class="text-3xl font-bold">{{ tasks.count }}</p>
      <p class="text-sm text-black">linked to these rooms</p>
    </div>
  </section>

    {#Room n assets overview#}
  <section class="grid gap-4 grid-cols-2">
    <div class="border rounded bg-[#dbf3fa] p-4">
      <p class="text-md mb-2">Room list</p>
      {% if rooms %}
        <ul class="space-y-1 max-h-64 overflow-y-auto text-sm">
          {% for room in rooms %}
            {#fyi, justify between within container puts them on separate ends#}
            <li class="flex justify-between">
              <span>{{ room.name }}</span>
              <span class="text-xs">{{ room.assets.count }} assets</span>
              <div>
                {# button to sort by room #}
                <form method="POST"
                action="{% url 'dashboard'%}">
                {% csrf_token %}
                <input type="hidden" name="action" value="sort-room">
                <input type="hidden" name="room_id" value="{{room.room_id}}">
                <button type="submit" title="Sort Room" style="color: #f0ca30">Sort By</button>
                </form>
                {# button to delete room #}
                <form method="POST"
                action="{% url 'dashboard'%}"
                onsubmit="return confirm('Want to delete this room?')">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete-room">
                <input type="hidden" name="room_id" value="{{room.room_id}}">
                <button type="submit" title="Delete Room" class="text-red-400">Delete

                </button>
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-xs">No rooms yet.</p>
      {% endif %}
    </div>
    <div class="border rounded bg-[#dbf3fa] p-4">
      <p class="text-md mb-2">Assets</p>
      {% if assets %}
        <ul class="space-y-1 text-sm max-h-64 overflow-y-auto">
          {% for asset in assets %}
            {#last makes sure that the last item does not get the styling#}
            <li class=" flex justify-between items-start border-zinc-400 border-b pb-2 last:border-none">
              <div>
                <div class="font-medium text-black">{{ asset.details.name }}</div>
                <div class="text-xs text-black">
                  {% if asset.details.brand %}
                    {{ asset.details.brand }}
                  {% else %}
                    Unknown
                  {% endif %}
                  -
                  {% if asset.category %}
                    {{ asset.category }}
                  {% else %}
                    General
                  {% endif %}
                </div>
              </div>
              <div class="text-xs text-black">Room: {{ asset.room.name }}</div>
              
              
              <div class = "flex flex-col items-end space-y-2">

                {# button to sort by asset #}
                <form method="POST"
                action="{% url 'dashboard'%}">
                {% csrf_token %}
                  <input type="hidden" name="action" value="sort-asset">
                  <input type="hidden" name="asset_id" value="{{asset.asset_id}}">
                  <button type="submit" title="Sort Asset" style="color: #f0ca30">Sort By</button>
              </form>
                {#Deleting asset#}
                <form method="POST" action="{% url 'dashboard'%}"
                onsubmit="return confirm('Want to delete {{asset.name}}?')">
                {% csrf_token %}
                  <input type="hidden" name="action" value="delete-asset">
                  <input type="hidden" name="asset_id" value="{{asset.asset_id}}">
                  <button type="submit" title="Delete Asset" class="text-red-400">Delete
                  </button>                
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-xs text-black">Select or create a room to see assets.</p>
      {% endif %}
    </div>
  </section>

    {#Tasks and due soon section#}
  <section class="grid gap-4 grid-cols-2">
    <div class="border rounded bg-[#dbf3fa] p-4">
      <p class="text-sm mb-2">Tasks</p>
      {% if tasks %}
{#          Overflow turns the area into scroll once content taks up max height#}
        <ul class="space-y-2 text-sm max-h-64 overflow-y-auto pr-2">
          {% for task in tasks %}
            <li class="border-b pb-2 last:border-none">
              <div class="font-medium">{{ task.name }}</div>
              <div class="text-xs text-black">Location: {% if task.asset %}{{ task.asset.details.name }}{% elif task.room %}{{ task.room.name }}{% else %}General{% endif %}</div>
              <div class="text-xs text-black">
                Interval: {% if task.interval %}{{ task.get_interval_display }}{% else %}Not set{% endif %}
              </div>
              <div class="text-xs text-black">Status: TODO....</div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-xs text-black">Add a task to track maintenance or chores.</p>
      {% endif %}
    </div>
    <div class="border rounded bg-[#dbf3fa] p-4">
      <p class="text-sm  mb-2">Due soon</p>
      {% if upcoming_occurrences %}
        <ul class="space-y-2 text-sm max-h-64 overflow-y-auto pr-2">
          {% for entry in upcoming_occurrences %}
            <li class="border-b pb-2 last:border-none flex justify-between items-start text-black">
              <div>
                <div class="font-medium">{{ entry.task.name }}</div>
                <div class="text-xs text-gray-800">Assigned: {% if entry.task.asset %}{{ entry.task.asset.details.name }}{% elif entry.task.room %}{{ entry.task.room.name }}{% else %}General{% endif %}</div>
                <div class="text-xs text-gray-800">
                  Next due: {% if entry.due_date %}{{ entry.due_date|date:"M. d, Y" }}{% else %}TBD{% endif %}
                </div>
              </div>
              <div class = "text-right flex flex-col items-end">
                {% if entry.task.days_until_due != None%}
                  {% if entry.task.days_until_due <= 4 %}
                    <span class="px-2 py-0.5 rounded bg-red-500 text-white font-bold text-[10px] animate-pulse">URGENT</span>
                  {% elif entry.task.days_until_due <= 7 %}
                      <span class="px-2 py-0.5 rounded bg-amber-500 text-white font-bold text-[10px]">SOON</span>
                  {% elif entry.task.days_until_due <= 14 %}
                      <span class="px-2 py-0.5 rounded bg-white text-black border border-gray-300 text-[10px]">UPCOMING</span>
                  {% endif %}
                <span class="text-[10px] block mt-1">{{ entry.task.days_until_due }} days left</span>
                {% endif %}
              </div>
      
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-xs text-gray-800">Tasks become due after they are added here.</p>
      {% endif %}
    </div>
  </section>

    {#Activity log secton. Takes up full width when max not specified#}
  <section class="border rounded bg-[#dbf3fa] p-4">
    <p class="text-sm mb-2">Activity log</p>
    {% if logs %}
      <ul class="space-y-2 max-h-64 overflow-y-auto text-sm">
        {% for log in logs %}
          <li class="border-b pb-2 last:border-none">
            <div class="font-medium">{{ log.task.name }}</div>
            <div class="text-xs text-black">
              Completed: {% if log.completion_date %}{{ log.completion_date }}{% else %}Pending{% endif %}
            </div>
            <div class="text-xs text-black">
              Cost: {% if log.cost %}{{ log.cost }}{% else %}â€”{% endif %}
            </div>
            <div class="text-xs text-black">
              Notes: {% if log.notes %}{{ log.notes }}{% else %}No notes{% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-xs text-black">Logs show task history once recorded</p>
    {% endif %}
  </section>

  {#Add room  & asset section#}
  <section class="grid gap-4 md:grid-cols-2">
    <form method="post" class="border rounded bg-[#dbf3fa] p-4 space-y-2">
      {% csrf_token %}
        {#These inputs tell our backend what actions to perform and which room view to return after submission#}
      <input type="hidden" name="action" value="add-room">
      <input type="hidden" name="return_room" value="{{ selected_room_id }}">
      <p class="text-sm ">Add room</p>
      <input name="room_name" placeholder="Room name" class="w-full border px-2 py-1" required>
      <textarea name="room_description" placeholder="Description" class="w-full border px-2 py-1" rows="2"></textarea>
      <button type="submit" class="border px-3 py-1">Save</button>
    </form>
    {#This represents the stored assets form, which will be displayed by default#}
    <div id="storedAssetSection" class="space-y-2">
      <form method="post" class="border rounded bg-[#dbf3fa] p-4 space-y-2">
        {% csrf_token %}
        <input type="hidden" name="action" value="add-custom-asset">
        <input type="hidden" name="return_room" value="{{ selected_room_id }}">
        <p class="text-sm ">Add asset</p>
        {#Brand Selector#}
        <select name="brand" id="brandSelect" class="w-full border px-2 py-1" required>
          <option value="">Select Brand</option>
          {% for brand in brands %}
            <option value="{{ brand }}">{{ brand }}</option>
          {% endfor %}
        </select>
        {#Name Selector#}
        <select name="name" id="nameSelect" class="w-full border px-2 py-1" required>
          <option value="">Select Name</option>
          {% for asset in stored_asset_details %}
            <option value="{{ asset.name }}" data-brand="{{ asset.brand }}">{{ asset.name }}</option>
          {% endfor %}
        </select>
        {#Model Selector#}
        <select name="model_number" id="modelSelect" class="w-full border px-2 py-1" required>
          <option value="">Select Model Number</option>
          {% for item in asset_details %}
          <option value="{{ item.model_number }}" data-brand="{{ item.brand }}" data-name="{{ item.name }}">{{ item.model_number }}</option>
          {% endfor %}
        </select>
        {#Category Selector#}
        <select name="asset_category" class="w-full border px-2 py-1">
            {% for value, label in category_choices %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
        {#Room Selector#}
        <select name="asset_room" class="w-full border px-2 py-1">
          <option value="" class="">Select Room</option>
          {% for room in rooms %}
            <option value="{{ room.room_id }}">{{ room.name }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="border px-3 py-1">Save</button>
        <button type="button" id="customModeBtn" class="border px-3 py-1">Add Your Own</button>
      </form>
    </div>
    {#This represents the custom assets form, which will be displayed after clicking the button#}
    <div id="customAssetSection" class="space-y-2 hidden">
      <form method="post" class="border rounded bg-[#dbf3fa] p-4 space-y-2">
        {% csrf_token %}
        <input type="hidden" name="action" value="add-custom-asset">
        <input type="hidden" name="return_room" value="{{ selected_room_id }}">
        <p class="text-sm ">Add custom asset</p>
          {#Again, these inputs tell our backend what actions to perform and which room view to return after submission#}
        <input name="asset_name" placeholder="Asset name" class="w-full border px-2 py-1" required>
        <select name="asset_category" id="categorySelect" class="w-full border px-2 py-1">
            {% for value, label in category_choices %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
          {#This container is encapsulates the conditional fields that are dependen on the categorySelect being Appliance. See script below! :)#}
          {#None hides the div when the page first loads#}
        <div id="applianceFields" style="display: none;" class="space-y-2">
          <input name="asset_brand" placeholder="Brand" class="w-full border px-2 py-1">
          <input name="asset_model_number" placeholder="Model Number" class="w-full border px-2 py-1">
        </div>
        <select name="asset_room" class="w-full border px-2 py-1">
          <option value="" class="">Select Room</option>
          {% for room in rooms %}
            <option value="{{ room.room_id }}">{{ room.name }}</option>
          {% endfor %}
        </select>
        <button type="submit" class="border px-3 py-1">Save</button>
        <button type="button" id="storedModeBtn" class="border px-3 py-1">Use a Premade</button>
      </form>
    </div>
  </section>

    {#Add task & log section. It is basically just a copy paste of the asset but for logs and tasks#}
  <section class="grid gap-4 md:grid-cols-2">
    <form method="post" class="border rounded bg-[#dbf3fa] p-4 space-y-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="add-task">
      <input type="hidden" name="return_room" value="{{ selected_room_id }}">
      <p class="text-sm ">Add task</p>
    <div class="border-b space-y-2 pb-2">
        <input name="task_name" placeholder="Task name (e.g., change air filter)" class="w-full border px-2 py-1" required>
        <select name="task_interval" class="w-full border px-2 py-1" required title="Select how often this task recurs">
            <option value="">Choose an interval</option>
            {% for value, label in interval_choices %}
                <option value="{{ value }}">{{ label }}</option>
            {% endfor %}
        </select>
        <input type="date" name="task_start_date" placeholder="First due date" class="w-full border px-2 py-1" required>
        <p class="text-xs text-gray-400">Select the first due date</p>
    </div>

      <select name="task_room" class="w-full border px-2 py-1">
        <option value="">Room (optional)</option>
        {% for room in rooms %}
          <option value="{{ room.room_id }}">{{ room.name }}</option>
        {% endfor %}
      </select>
      <select name="task_asset" class="w-full border px-2 py-1">
        <option value="">Asset (optional)</option>
        {% for asset in asset_choices %}
          <option value="{{ asset.asset_id }}">{{ asset.details.name }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="border px-3 py-1">Save</button>
    </form>
    <form method="post" class="border rounded bg-[#dbf3fa] p-4 space-y-2">
      {% csrf_token %}
      <input type="hidden" name="action" value="add-log">
      <input type="hidden" name="return_room" value="{{ selected_room_id }}">
      <p class="text-sm ">Add log</p>
    <div class="border-b space-y-2 pb-2">
        <select name="log_task" class="w-full border px-2 py-1" required>
            <option value="">Choose task</option>
            {% for task in task_choices %}
                <option value="{{ task.task_id }}">{{ task.name }}</option>
            {% endfor %}
        </select>
        <input type="date" name="log_completion_date" class="w-full border px-2 py-1">
        <p class="text-xs text-gray-400">Completion date (optional)</p>
    </div>

      <input name="log_cost" placeholder="Cost" class="w-full border px-2 py-1">
      <textarea name="log_notes" placeholder="Notes" class="w-full border px-2 py-1" rows="2"></textarea>
      <button type="submit" class="border px-3 py-1">Save</button>
    </form>
  </section>
  <script>
      {#Listens for chanfs to the category select section. If the current category is appliance, show the brand and model fields.#}
    document.getElementById('categorySelect').addEventListener('change', function() {
        const applianceDiv = document.getElementById('applianceFields');

        applianceDiv.style.display = this.value === 'appliance' ? 'block' : 'none';
    });
  </script>
  <script>
    {#Responsible for switching between stored & custom asset forms#}
    const storedBtn = document.getElementById("storedModeBtn");
    const customBtn = document.getElementById("customModeBtn");
    const storedSection = document.getElementById("storedAssetSection");
    const customSection = document.getElementById("customAssetSection");

    // Default state
    customSection.classList.add("hidden");
    storedSection.classList.remove("hidden");

    storedBtn.addEventListener("click", function () {
      storedSection.classList.remove("hidden");
      customSection.classList.add("hidden");
    });

    customBtn.addEventListener("click", function () {
      storedSection.classList.add("hidden");
      customSection.classList.remove("hidden");
    });
</script>
<script>
  {#Filters drop downs for stored assets#}
  const brandSelect = document.getElementById("brandSelect");
  const nameSelect = document.getElementById("nameSelect");
  const modelSelect = document.getElementById("modelSelect");

  // Helper function to filter
  function filterOptions(selectElement, filterFunc) {
    for (const option of selectEl.options) {
      if (!option.value) continue;
      option.hidden = !filterFn(option);
    }
    selectEl.selectedIndex = 0;
  }

  // Filter upon update of brand
  brandSelect.addEventListener("change", function() {
    const selectedBrand = brandSelect.value;

    filterOptions(nameSelect, option => option.dataset.brand === selectedBrand);
    filterOptions(modelSelect, option => option.dataset.brand === selectedBrand);
  });

  // Filter upon update of name
  nameSelect.addEventListener("change", function() {
    const selectedBrand = brandSelect.value;
    const selectedName = nameSelect.value;

    filterOptions(modelSelect, option => 
      option.dataset.brand === selectedBrand && option.dataset.name === selectedName
    );
  });
</script>
</div>
{% endblock %}
