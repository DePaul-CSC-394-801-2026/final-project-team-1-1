{% extends 'base.html' %}
{% block content %}
<div class="max-w-5xl mx-auto space-y-5">
  <header class="border-b border-black pb-4">
    <h1 class="text-2xl text-black">Dashboard</h1>
    <p class="text-md text-black">Welcome, {{ request.session.username }}.</p>
  </header>

    {#Global stats#}
  <section class="grid grid-cols-3 gap-4">
    <div class="border rounded p-3 bg-[#dbf3fa] text-black">
      <p class="text-xs uppercase text-black">Rooms</p>
      <p class="text-3xl font-bold">{{ rooms.count }}</p>
      <p class="text-sm text-black">total</p>
    </div>
    <div class="border text-black rounded p-3 bg-[#dbf3fa]">
      <p class="text-xs uppercase text-black">Assets</p>
      <p class="text-3xl font-bold text-black">{{ assets.count }}</p>
      <p class="text-sm text-black">in view</p>
    </div>
    <div class="border text-black rounded p-3 bg-[#dbf3fa]">
      <p class="text-xs uppercase ">Tasks</p>
      <p class="text-3xl font-bold ">{{ tasks.count }}</p>
      <p class="text-sm ">linked to these rooms</p>
    </div>
  </section>

    {#Room n assets overview#}
  <section class="grid text-black gap-4 grid-cols-2">
    <div class="border text-black rounded bg-[#dbf3fa] p-4">
      <p class="text-md mb-2">Room list</p>
      {% if rooms %}
        <ul class="space-y-1 max-h-64 overflow-y-auto text-sm">
          {% for room in rooms %}
            {#fyi, justify between within container puts them on separate ends#}
            <li class="flex justify-between">
              <span>{{ room.name }}</span>
              <span class="text-xs">{{ room.assets.count }} assets</span>
              <div>
                {# button to sort by room #}
                <form method="POST"
                action="{% url 'dashboard'%}">
                {% csrf_token %}
                <input type="hidden" name="action" value="sort-room">
                <input type="hidden" name="room_id" value="{{room.room_id}}">
                <button type="submit" title="Sort Room" class="text-xs text-yellow-400">Sort By</button>
                </form>
                {# button to delete room #}
                <form method="POST"
                action="{% url 'dashboard'%}"
                onsubmit="return confirm('Want to delete this room?')">
                {% csrf_token %}
                <input type="hidden" name="action" value="delete-room">
                <input type="hidden" name="room_id" value="{{room.room_id}}">
                <button type="submit" title="Delete Room" class="text-xs text-red-400">Delete

                </button>
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-xs">No rooms yet.</p>
      {% endif %}
    </div>
    <div class="border rounded bg-[#dbf3fa] p-4">
      <p class="text-md mb-2">Assets</p>
      {% if assets %}
        <ul class="space-y-1 text-sm max-h-64 overflow-y-auto">
          {% for asset in assets %}
            {#last makes sure that the last item does not get the styling#}
            <li class=" text-black flex justify-between items-start border-zinc-400 border-b pb-2 last:border-none">
              <div>
                <div class="font-medium text-black">{{ asset.name }}</div>
{#                Display if it has a brand/consumable#}
                {% if asset.brand %}
                  <div class="text-xs text-black">Brand: {{ asset.brand }}</div>
                {% endif %}
                {% if asset.consumable_name %}
                  <div class="text-xs text-black">
                    Consumable: {{ asset.consumable_name }}
                  </div>
                {% endif %}
              </div>
              <div class="text-xs text-black">Room: {{ asset.room.name }}</div>


              <div class = "flex flex-col items-end space-y-2">

                {# button to sort by asset #}
                <form method="POST"
                action="{% url 'dashboard'%}">
                {% csrf_token %}
                  <input type="hidden" name="action" value="sort-asset">
                  <input type="hidden" name="asset_id" value="{{asset.asset_id}}">
                  <button type="submit" title="Sort Asset" class="text-xs text-yellow-400">Sort By</button>
              </form>
                {#Deleting asset#}
                <form method="POST" action="{% url 'dashboard'%}"
                onsubmit="return confirm('Want to delete {{asset.name}}?')">
                {% csrf_token %}
                  <input type="hidden" name="action" value="delete-asset">
                  <input type="hidden" name="asset_id" value="{{asset.asset_id}}">
                  <button type="submit" title="Delete Asset" class="text-xs text-red-400">Delete
                  </button>
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-xs text-black">Select or create a room to see assets.</p>
      {% endif %}
    </div>
  </section>

    {#Tasks and due soon section#}
  <section class="grid text-black gap-4 grid-cols-2">
    <div class="border rounded bg-[#dbf3fa] p-4">
      <p class="text-sm mb-2">Tasks</p>
      {% if tasks %}
{#          Overflow turns the area into scroll once content taks up max height#}
        <ul class="space-y-2 text-sm max-h-64 overflow-y-auto pr-2">
          {% for task in tasks %}
            <li class="border-b pb-2 last:border-none">
              <div class="font-medium">{{ task.name }}</div>
              <div class="text-xs text-black">Location: {% if task.asset %}{{ task.asset.name }}{% elif task.room %}{{ task.room.name }}{% elif task.home %}{{ task.home.name }}{% else %}General{% endif %}</div>
              <div class="text-xs text-black">
                Interval: {% if task.interval %}{{ task.get_interval_display }}{% else %}Not set{% endif %}
              </div>
              <div class="text-xs text-black">Status: TODO....</div>
              <div class="flex justify-end mt-2">
                <form method="POST" action="{% url 'dashboard' %}">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="delete-task">
                  <input type="hidden" name="task_id" value="{{ task.task_id }}">
                  <input type="hidden" name="return_room" value="{{ selected_room_id }}">
                  <button type="submit" class="text-xs text-red-400">Delete</button>
                </form>
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-xs text-black">Add a task to track maintenance or chores.</p>
      {% endif %}
    </div>
    <div class="border rounded bg-[#dbf3fa] p-4">
      <p class="text-sm  mb-2">Due soon</p>
      {% if due_soon_tasks %}
        <ul class="space-y-2 text-sm max-h-64 overflow-y-auto pr-2">
          {% for task in due_soon_tasks %}
            <li class="border-b pb-2 last:border-none flex justify-between items-start text-black">
              <div>
                <div class="font-medium">{{ task.name }}</div>
                <div class="text-xs text-black">Assigned: {% if task.asset %}{{ task.asset.name }}{% elif task.room %}{{ task.room.name }}{% elif task.home %}{{ task.home.name }}{% else %}General{% endif %}</div>
                <div class="text-xs text-black">
                  Next due: {% if task.next_due_date %}{{ task.next_due_date|date:"M. d, Y" }}{% else %}TBD{% endif %}
                </div>
              </div>
              <div class = "text-right flex flex-col items-end">
                {% if task.days_until_due != None %}
                  {% if task.days_until_due <= 4 %}
                    <span class="px-2 py-0.5 rounded bg-red-500 text-white font-bold text-[10px] animate-pulse">URGENT</span>
                  {% elif task.days_until_due <= 7 %}
                      <span class="px-2 py-0.5 rounded bg-amber-500 text-white font-bold text-[10px]">SOON</span>
                  {% elif task.days_until_due <= 14 %}
                      <span class="px-2 py-0.5 rounded bg-white text-black border border-gray-300 text-[10px]">UPCOMING</span>
                  {% endif %}
                  <span class="text-[10px] block mt-1">{{ task.days_until_due }} days left</span>
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-xs text-black">Tasks become due after they are added here.</p>
      {% endif %}
    </div>
  </section>

    {#Activity log secton. Takes up full width when max not specified#}
  <section class="text-black border rounded bg-[#dbf3fa] p-4">
    <p class="text-sm mb-2">Activity log</p>
    {% if logs %}
      <ul class="space-y-2 max-h-64 overflow-y-auto text-sm">
        {% for log in logs %}
          <li class="border-b pb-2 last:border-none">
            <div class="font-medium">{{ log.task.name }}</div>
            <div class="text-xs text-black">
              Completed: {% if log.completion_date %}{{ log.completion_date }}{% else %}Pending{% endif %}
            </div>
            <div class="text-xs text-black">
              Cost: {% if log.cost %}{{ log.cost }}{% else %}â€”{% endif %}
            </div>
            <div class="text-xs text-black">
              Notes: {% if log.notes %}{{ log.notes }}{% else %}No notes{% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-xs text-black">Logs show task history once recorded</p>
    {% endif %}
  </section>

</div>
{% endblock %}
